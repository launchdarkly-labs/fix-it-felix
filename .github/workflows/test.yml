name: Test Fix-it Felix Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build action
        run: npm run build

      - name: Package action
        run: npm run package

  # Test functionality: Verify Felix detects formatting issues (dry run)
  test-functionality:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test files with intentional issues
        run: |
          mkdir temp-test
          cat > temp-test/bad.js << 'EOF'
          const   x=1;
          let y= 2   ;
          console.log(x,y)
          EOF

          cat > temp-test/bad.md << 'EOF'
          # Test File

          This is a test file with some   extra spaces.



          And too many blank lines.
          EOF

      - name: Test Fix-it Felix functionality (dry run)
        uses: ./
        with:
          fixers: 'prettier,markdownlint'
          paths: 'temp-test'
          dry_run: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Check for uncommitted dist changes
  check-dist:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if dist is up to date
        run: |
          npm run build
          if ! git diff --quiet dist/; then
            echo "❌ dist/ folder is not up to date. Please run 'npm run build' and commit the changes."
            git diff dist/
            exit 1
          else
            echo "✅ dist/ folder is up to date."
          fi

  # Dogfood: Actually fix formatting issues in this repo (real run)
  dogfood:
    runs-on: ubuntu-latest
    needs: [test, test-functionality, check-dist]
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Fix formatting issues with Felix (real run)
        uses: ./
        with:
          commit_message: '🤖 Fix-it Felix: Auto-fix formatting issues'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
