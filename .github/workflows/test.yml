name: Test Fix-it Felix Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build action
        run: npm run build

      - name: Package action
        run: npm run package

  # Dogfood: Use Felix on this repo itself
  dogfood:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug dogfood environment
        run: |
          echo "=== Dogfood Debug Info ==="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Working directory contents:"
          ls -la
          echo "Felix config:"
          cat .felixrc.json || echo "No .felixrc.json found"
          echo "=========================="

      - name: Test Fix-it Felix on this repo (dogfood)
        uses: ./
        with:
          dry_run: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Test functionality: Verify Felix detects formatting issues
  test-functionality:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test files with intentional issues
        run: |
          mkdir temp-test
          cat > temp-test/bad.js << 'EOF'
          const   x=1;
          let y= 2   ;
          console.log(x,y)
          EOF

          cat > temp-test/bad.md << 'EOF'
          # Test File

          This is a test file with some   extra spaces.



          And too many blank lines.
          EOF

      - name: Debug functionality test environment  
        run: |
          echo "=== Functionality Test Debug Info ==="
          echo "Created test files:"
          ls -la temp-test/
          echo "temp-test/bad.js contents:"
          cat temp-test/bad.js
          echo "temp-test/bad.md contents:"
          cat temp-test/bad.md
          echo "====================================="

      - name: Test Fix-it Felix functionality
        uses: ./
        with:
          fixers: 'prettier,markdownlint'
          paths: 'temp-test'
          dry_run: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Integration test: Real commit mode (only on PRs)
  integration-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Test Fix-it Felix (real run)
        uses: ./
        with:
          fixers: 'prettier'
          commit_message: 'ğŸ§ª Test commit from Fix-it Felix'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
